<?xml version="1.0" encoding="UTF-8"?>
<ruleset name="AppExchange"
         xmlns="http://pmd.sourceforge.net/ruleset/2.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://pmd.sourceforge.net/ruleset/2.0.0 https://pmd.sourceforge.io/ruleset_2_0_0.xsd">
    <description>AppExchange Security Rules</description>


    <rule name="AvoidApiSessionId"
          language="xml"
          class="net.sourceforge.pmd.lang.rule.xpath.XPathRule"
          message="Session ID use is not approved.">
        <!-- TODO: NEED TO ADD IN externalInfoUrl ONCE WE HAVE A PERMANENT LOCATION FOR THE DOC PAGE -->
        <description>Detects use of Api.Session_ID or GETSESSIONID() to retrieve a session ID.</description>
        <priority>2</priority>
        <properties>
            <property name="xpath">
                <value><![CDATA[
//text[
    contains(upper-case(@Text),"API.SESSION_ID")
    or
    contains(upper-case(@Text),"GETSESSIONID")
]/..
                ]]></value>
            </property>
        </properties>
    </rule>


    <rule name="AvoidAuraWithLockerDisabled"
          language="xml"
          class="net.sourceforge.pmd.lang.rule.xpath.XPathRule"
          message="To enable Lightning Locker, update the apiVersion to version 40 or greater.">
        <!-- TODO: NEED TO ADD IN externalInfoUrl ONCE WE HAVE A PERMANENT LOCATION FOR THE DOC PAGE -->
        <description>Detects use of API versions with Lightning Locker disabled in Aura components. Use API version 40 or greater.</description>
        <priority>1</priority>
        <properties>
            <property name="xpath">
                <value><![CDATA[
/document/AuraDefinitionBundle/apiVersion/text[number(@Text) lt 40]
                ]]></value>
            </property>
        </properties>
    </rule>


    <rule name="AvoidDisableProtocolSecurity"
          language="xml"
          class="net.sourceforge.pmd.lang.rule.xpath.XPathRule"
          message="Protocol security setting is disabled.">
        <!-- TODO: NEED TO ADD IN externalInfoUrl ONCE WE HAVE A PERMANENT LOCATION FOR THE DOC PAGE -->
        <description>Detects if &quot;Disable Protocol Security&quot; setting is true.</description>
        <priority>3</priority>
        <properties>
            <property name="xpath">
                <value><![CDATA[
/document/RemoteSiteSetting/disableProtocolSecurity/text[@Text="true"]
                ]]></value>
            </property>
        </properties>
    </rule>


    <rule name="AvoidInsecureHttpRemoteSiteSetting"
          language="xml"
          class="net.sourceforge.pmd.lang.rule.xpath.XPathRule"
          message="Avoid using insecure http urls in Remote Site Settings.">
        <!-- TODO: NEED TO ADD IN externalInfoUrl ONCE WE HAVE A PERMANENT LOCATION FOR THE DOC PAGE -->
        <description>Detects instances of a Remote Site Settings that use HTTP. Use HTTPS instead.</description>
        <priority>3</priority>
        <properties>
            <property name="xpath">
                <value><![CDATA[
/document/RemoteSiteSetting/url/text[starts-with(lower-case(@Text),"http://")]
                ]]></value>
            </property>
        </properties>
    </rule>


    <rule name="AvoidJavaScriptCustomObject"
          language="xml"
          class="net.sourceforge.pmd.lang.rule.xpath.XPathRule"
          message="Avoid using JavaScript to execute custom button actions.">
        <!-- TODO: NEED TO ADD IN externalInfoUrl ONCE WE HAVE A PERMANENT LOCATION FOR THE DOC PAGE -->
        <description>Detects use of custom JavaScript actions in custom rules.</description>
        <priority>2</priority>
        <properties>
            <property name="xpath">
                <value><![CDATA[
/document/WebLink/openType/text[@Text="onClickJavaScript"]/../../url
                ]]></value>
            </property>
        </properties>
    </rule>


    <rule name="AvoidJavaScriptHomePageComponent"
          language="xml"
          class="net.sourceforge.pmd.lang.rule.xpath.XPathRule"
          message="Avoid JavaScript in a home page component body.">
        <description>Detects use of custom JavaScript actions in home page components.</description>
        <!-- TODO: NEED TO ADD IN externalInfoUrl ONCE WE HAVE A PERMANENT LOCATION FOR THE DOC PAGE -->
        <priority>2</priority>
        <properties>
            <property name="xpath">
                <value><![CDATA[
/document/HomePageComponent/body/text[
    contains(upper-case(@Text),upper-case('<script>'))
    or
    contains(upper-case(@Text),upper-case('<script '))
    or
    contains(upper-case(@Text),upper-case('javascript:'))
]
                ]]></value>
            </property>
        </properties>
    </rule>


    <rule name="AvoidLmcIsExposedTrue"
          language="xml"
          class="net.sourceforge.pmd.lang.rule.xpath.XPathRule"
          message="Detected Lightning Message Channel with isExposed set to true.">
        <!-- TODO: NEED TO ADD IN externalInfoUrl ONCE WE HAVE A PERMANENT LOCATION FOR THE DOC PAGE -->
        <description>Detects a Lightning Message Channel with isExposed=true, which isnâ€™t allowed in managed packages.</description>
        <priority>2</priority>
        <properties>
            <property name="xpath">
                <value><![CDATA[
/document/LightningMessageChannel/isExposed/text[@Text="true"]
                ]]></value>
            </property>
        </properties>
    </rule>


    <rule name="AvoidSControls"
          language="xml"
          class="net.sourceforge.pmd.lang.rule.xpath.XPathRule"
          message="Detected S-Controls.">
        <!-- TODO: NEED TO ADD IN externalInfoUrl ONCE WE HAVE A PERMANENT LOCATION FOR THE DOC PAGE -->
        <description>Detects if S-Controls are used since they should not be used in managed packages.</description>
        <priority>1</priority>
        <properties>
            <property name="xpath">
                <value><![CDATA[
/document/Scontrol
                ]]></value>
            </property>
        </properties>
    </rule>


    <rule name="LimitConnectedAppScope"
          language="xml"
          class="net.sourceforge.pmd.lang.rule.xpath.XPathRule"
          message="Detected connected app using full scope.">
        <!-- TODO: NEED TO ADD IN externalInfoUrl ONCE WE HAVE A PERMANENT LOCATION FOR THE DOC PAGE -->
        <description>Detects if a connected app uses full scope instead of limited scope. Explain this use case in your AppExchange security review submission.</description>
        <priority>3</priority>
        <properties>
            <property name="xpath">
                <value><![CDATA[
/document/ConnectedApp/oauthConfig/scopes/text[upper-case(@Text)="FULL"]
                ]]></value>
            </property>
        </properties>
    </rule>


    <rule name="ProtectSensitiveData"
          language="xml"
          class="com.salesforce.security.pmd.xml.DetectSecretsInCustomObjects"
          message="To store secrets, use Protected Custom settings or Protected Custom metadata.">
        <!-- TODO: NEED TO ADD IN externalInfoUrl ONCE WE HAVE A PERMANENT LOCATION FOR THE DOC PAGE -->
        <description>Detects where sensitive data must be stored with Protected Custom metadata or Protected Custom settings. Protected custom settings or protected custom metadata should be used to store secrets. Refer to the "Protect Secrets Using Platform Features" Trailhead module for more guidance.</description>
        <priority>3</priority>
    </rule>


    <rule name="UseHttpsCallbackUrl"
          language="xml"
          class="net.sourceforge.pmd.lang.rule.xpath.XPathRule"
          message="Update to secure Oauth callback URL over HTTPS.">
        <!-- TODO: NEED TO ADD IN externalInfoUrl ONCE WE HAVE A PERMANENT LOCATION FOR THE DOC PAGE -->
        <description>Detects instances of an OAuth callback URL that uses HTTP. Use HTTPS instead.</description>
        <priority>3</priority>
        <properties>
            <property name="xpath">
                <value><![CDATA[
/document/ConnectedApp/oauthConfig/callbackUrl/text[contains(lower-case(@Text),"http://")]
                ]]></value>
            </property>
        </properties>
    </rule>

</ruleset>